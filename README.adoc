= Modshells: Modular Shell Configuration Manager
:toc: macro
:toc-title: Contents
:toclevels: 3
:icons: font
:source-highlighter: rouge
:experimental:

A declarative, idempotent configuration manager for modularising shell environments.
Written in Ada for safety-critical reliability.

toc::[]

== Deliverable

**Modshells** is a command-line tool that transforms monolithic shell configuration files into a modular, maintainable directory structure. The tool:

1. **Creates** a standardised directory hierarchy for shell configurations
2. **Detects** installed shells on your system (Bash, Zsh, Fish, Nushell, and 6 others)
3. **Injects** sourcing logic into shell configuration files (with backup)
4. **Ensures idempotency** - safe to run multiple times without side effects

=== Current Status

[cols="1,1"]
|===
| Aspect | Status

| Directory creation | Working
| Shell detection | Stub (returns hardcoded list)
| Config backup | Not implemented
| Source injection | Not implemented
|===

*This is alpha software.* The core architecture is complete, but the primary feature (modularising shell configs) is not yet functional. See <<Development Status>> for details.

=== What You Get

After running `modshells`, your shell configurations are organised into:

[source]
----
~/.config/nushell/modshells/
├── core/       # PATH, prompt, history, shell options
├── tools/      # git, fzf, starship, direnv configs
├── misc/       # Custom aliases and functions
├── os/         # Linux vs macOS differences
└── ui/         # Themes and visual settings
----

Each shell's config file (`.bashrc`, `.zshrc`, etc.) sources these directories automatically. Add a new alias? Drop a file into `misc/`. OS-specific tweak? Put it in `os/`. Done.

== The Problem

Traditional shell configuration becomes unwieldy:

* Single files grow to hundreds of lines
* Related configurations scattered throughout
* Difficult to share configurations across shells
* No clear separation of concerns
* Risky manual editing of critical dotfiles

== The Solution

Modshells creates a standardised modular structure with shell-agnostic or shell-specific configuration snippets that are automatically sourced in order.

== Features

=== Multi-Shell Support

Modshells detects and manages configurations for ten shells:

[cols="1,1,1"]
|===
| Shell | Status | Config File

| Bash | ✓ Supported | `.bashrc`
| Zsh | ✓ Supported | `.zshrc`
| Fish | ✓ Supported | `config.fish`
| Nushell | ✓ Primary | `config.nu`
| Ion | ✓ Supported | `initrc`
| Oils (OSH/YSH) | ✓ Supported | `.oshrc`
| Tcsh | ✓ Supported | `.tcshrc`
| Ksh | ✓ Supported | `.kshrc`
| Dash | ◐ Limited | `ENV` file
| PowerShell | ✓ Supported | `profile.ps1`
|===

=== Idempotent Operations

All Modshells operations are idempotent:

* Running the tool multiple times produces the same result
* Existing configurations are never destroyed
* Automatic backup before any modification
* Signature-based detection of already-modularised shells

=== Safety-First Design

Built in Ada for maximum reliability:

* Strong static typing catches errors at compile time
* Exception handling ensures graceful failure
* No unsafe memory operations
* Deterministic behaviour

== Architecture

=== Package Structure

[source]
----
src/
├── main/
│   └── modshells.adb          # Entry point
├── config_store/
│   ├── config_store.ads       # Configuration path interface
│   └── config_store.adb       # Environment & path resolution
└── shell_manager/
    ├── shell_manager.ads      # Shell operations interface
    └── shell_manager.adb      # Detection, creation, modularisation
----

=== Core Components

`Config_Store`:: Resolves the modshells root path from `MODSHELLS_CONFIG_PATH` environment variable or defaults to `~/.config/nushell/modshells`

`Shell_Manager`:: Handles shell detection, directory creation, modularisation checking, and configuration injection

=== Signature-Based Idempotency

Modshells uses a signature comment to detect previously modularised configurations:

[source,bash]
----
# MODSHELLS_START - DO NOT REMOVE THIS LINE
# ... sourcing logic ...
# MODSHELLS_END
----

This enables safe re-execution without duplicate injections.

== Installation

=== Prerequisites

* GNAT (Ada compiler) - typically via `gnat` or `gcc-ada` package
* GPRBuild (GNAT project builder)

=== Building from Source

[source,bash]
----
# Clone the repository
git clone https://github.com/hyperpolymath/modshells.git
cd modshells

# Build with GPRBuild
gprbuild -p -j0 modshells.gpr

# Binary is in bin/
./bin/modshells
----

=== Package Managers

[source,bash]
----
# Guix (primary)
guix install modshells

# Nix (alternative)
nix profile install github:hyperpolymath/modshells
----

== Usage

=== Current Functionality (v0.0)

[source,bash]
----
# Build and run
gprbuild -p -j0 modshells.gpr
./bin/modshells
----

Output:
[source]
----
Starting modshells initialisation...
Configuration path: /home/user/.config/nushell/modshells
Modular directories created idempotently.
----

This creates the directory structure. Shell detection and config injection are not yet functional.

=== Planned Functionality (v0.1+)

[source,bash]
----
# Initialise modular structure and inject into all detected shells
modshells

# Use custom configuration path
export MODSHELLS_CONFIG_PATH="$HOME/.config/shells/modular"
modshells

# Target specific shells only
modshells init --shell=bash,zsh
----

=== Populating Your Configuration

After initialisation, add configuration snippets:

[source,bash]
----
# Add a tool configuration
echo 'alias g="git"' > ~/.config/nushell/modshells/tools/git.sh

# Add OS-specific config
echo 'export BROWSER=firefox' > ~/.config/nushell/modshells/os/linux.sh
----

Files are sourced alphabetically. Use numeric prefixes for ordering:

[source]
----
core/
├── 00-path.sh
├── 10-prompt.sh
└── 20-history.sh
----

== Configuration

=== Environment Variables

`MODSHELLS_CONFIG_PATH`:: Override default configuration root directory. Default: `~/.config/nushell/modshells`

=== Modular Categories

[cols="1,3"]
|===
| Directory | Purpose

| `core/`
| Essential shell settings: PATH modifications, prompt configuration, history settings, shell options

| `tools/`
| Tool integrations: git aliases, fzf configuration, starship prompt, direnv, asdf

| `misc/`
| General aliases, utility functions, one-off customisations

| `os/`
| OS-specific configurations: Linux vs macOS differences, distro-specific settings

| `ui/`
| Visual customisations: colours, themes, terminal-specific settings
|===

== Development Status

Current version: **v0.0 (Alpha)**

=== Working Now

[cols="1,2"]
|===
| Feature | Description

| Directory creation
| Idempotently creates `core/`, `tools/`, `misc/`, `os/`, `ui/` structure

| Path resolution
| Reads `MODSHELLS_CONFIG_PATH` or defaults to `~/.config/nushell/modshells`

| Shell enumeration
| Defines 10 shell types (Bash, Zsh, Fish, Nushell, Ion, Oils, Tcsh, Ksh, Dash, PowerShell)

| Build system
| GPRBuild project files with CI/CD (GitHub Actions)

| Idempotency markers
| Signature-based detection to prevent duplicate injections
|===

=== Not Yet Implemented (Stubs)

[cols="1,2"]
|===
| Feature | Current State

| Shell detection
| Returns hardcoded list (Nushell, Bash, Zsh); needs `which`/`command -v` checks

| Config file backup
| Not implemented; required before modifying dotfiles

| Source injection
| Not implemented; the core feature that modifies `.bashrc`, `.zshrc`, etc.

| Shell-specific syntax
| Not implemented; each shell needs different sourcing syntax
|===

See link:ROADMAP.adoc[ROADMAP.adoc] for the complete development plan.

== Contributing

Contributions welcome. See link:CONTRIBUTING.md[CONTRIBUTING.md] for guidelines.

This project follows the Rhodium Standard Repository (RSR) conventions.

=== Language Policy

This project adheres to the Hyperpolymath Standard:

* **Ada** for core application logic
* **Nushell** for automation scripts
* **Bash/POSIX** for git hooks only

See `.claude/CLAUDE.md` for complete language policy.

== License

SPDX-License-Identifier: `AGPL-3.0-or-later OR MIT`

Dual-licensed under GNU Affero General Public License v3.0 or later, or MIT License. See link:LICENSE.txt[LICENSE.txt] for details.

== Citation

For academic use, see link:docs/CITATIONS.adoc[CITATIONS.adoc] for BibTeX, Harvard, OSCOLA, MLA, and APA 7 formats.
